#!/bin/zsh

file="$MM_EDIT_FILEPATH"

# Try to locate Neovim in PATH
nvim_path=$(command -v nvim)

# If not found, determine Mac architecture and use a fallback path
if [[ -z "$nvim_path" ]]; then
  arch=$(uname -m)
  if [[ "$arch" == "arm64" ]]; then
    nvim_path="/opt/homebrew/bin/nvim"  # Apple Silicon
  else
    nvim_path="/usr/local/bin/nvim"     # Intel
  fi
fi

# Final check to make sure the path is valid
if [[ ! -x "$nvim_path" ]]; then
  echo "⚠️  Neovim not found. Please make sure it is installed or manually update the nvim path in this script." >&2
  exit 1
fi

# Escape the file path to be safe in shell string
escaped_file=$(printf %q "$file")
escaped_nvim=$(printf %q "$nvim_path")

# Open Neovim in Ghostty via shell
/usr/bin/open -na "Ghostty" --args -e "zsh -c '$escaped_nvim $escaped_file'"
